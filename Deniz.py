import os, csv, math
import pandas as pd, numpy as np
from numpy import asarray
from sklearn.model_selection import train_test_split
from sklearn.neighbors import KNeighborsClassifier
from sklearn.metrics import  confusion_matrix
from sklearn.metrics import accuracy_score
from sklearn.naive_bayes import MultinomialNB
from sklearn import svm
'''#######################  Global Variables  #######################'''
fileList = []
future_dataList_1_0 = []
a_list = []
b_list = []
c_list = []
d_list = []
''''######################### FUNCTIONS #############################'''

#///////////////////////////////////////////////////////////////////////
#/////////////////////// APK PROCESSING ////////////////////////////////
#///////////////////////////////////////////////////////////////////////
#///////////////////////////////////////////////////////////////////////
#////////// fDecompileApk_and_ExtraxtAndroidManifestFile ///////////////
#///////////////////// fReadManifestFiles //////////////////////////////
#//////////////////////// fWriteCsvFile ////////////////////////////////
#///////////////////////////////////////////////////////////////////////
#///////////////////////////////////////////////////////////////////////

# Comment : Bu fonksiyon apk dosyalarindan uygulama ayar dosyalarini cikartiyor
def fDecompileApk_and_ExtraxtAndroidManifestFile(mPath,mType):  # mPath degiskeni apk dosyalarinin bulundugu dizin, mType ise Amd - Playstore
    # mPath uzerinde yer alan dosya isimlerini listeye aliyor
    for i in os.walk(mPath):
        fileList.append(i)

    if (mType == "Amd"):
        if not os.path.exists("Permission_Amd_App"):
            os.system("mkdir Permission_Amd_App")
        # Dosyalari cikart, AndroidManifest.xml dosyasini al. Diger dosyalari sil
        for item in fileList:
            if (len(item[2]) != 0):
                print('Yol: ' + item[0])
                for apkfilesinpath in item[2]:
                    os.system("java -jar apktool.jar d MalwareApp/" + apkfilesinpath + " && cd " + apkfilesinpath[:-4] + "&& move AndroidManifest.xml ../Permission_Amd_App/AndroidManifest_" + apkfilesinpath[:-4] + ".xml")
                    os.system("cd C:/Users/OsmanDeniz/Development/Bitirme/MalwareDetection/ && rd /s /q " + apkfilesinpath[:-4])

    elif (mType == "Playstore"):
        if not os.path.exists("PermissionPlayStoreApp"):
            os.system("mkdir PermissionPlayStoreApp")
        # Dosyalari cikart, AndroidManifest.xml dosyasini al. Diger dosyalari sil
        for item in fileList:
            if (len(item[2]) != 0):
                print('Yol: ' + item[0])
                for apkfilesinpath in item[2]:
                    # print(apkfilesinpath[:-4])
                    os.system("java -jar apktool.jar d PlayStoreApk/" + apkfilesinpath + " && cd " + apkfilesinpath[:-4] + " && move AndroidManifest.xml ../PermissionPlayStoreApp/AndroidManifest_" + apkfilesinpath[:-4] + ".xml")
                    os.system("cd C:/Users/OsmanDeniz/Development/Bitirme/MalwareDetection/ && rd /s /q " + apkfilesinpath[:-4])

# Comment : Bu fonksiyon özellik çikartma islemidir. AndroidManifest.xml dosyasindan izinleri bularak datasete ekleme yapiyor
def fReadManifestFiles(mPath, mType):
    global future_dataList_1_0, fileList
    mTempManifestFile = []
    temp = []
    # Klasor altindaki tum dosya isimlerini mTempManifestFile listesine al
    for i in os.walk(mPath):
        mTempManifestFile.append(i)
    # Google tarafindan yayinlanmis tum izinleri temp listesine al
    for satir in open(mPath + '../raw/android.permission'):
        temp.append(satir)
    # listeyi virgule gore ayir ve filelist listesine aktar
    fileList = str(temp[0]).split(",")
    if not os.path.exists(mPath + "../dataset.csv"):
        fWriteCsvFile('dataset.csv', fileList)
    for item in mTempManifestFile:
        # Klasor altinda yer alan her bir dosya icin
        for mManifestFileName in item[2]:
            print(mManifestFileName)

            for x in fileList:
                future_dataList_1_0.append(0)
            # ozellik cikartma asamasi
            for row in open(mPath + mManifestFileName):
                if "<uses-permission" in row:
                    list_iterator = 0
                    permission = row[35:-4]

                    for x in fileList:
                        if (permission == x):
                            print(permission)
                            future_dataList_1_0[list_iterator] = 1
                        list_iterator += 1
            if (mType == "malware"):
                future_dataList_1_0[len(future_dataList_1_0) - 1] = 1
            elif (mType == "being"):
                future_dataList_1_0[len(future_dataList_1_0) - 1] = 0

            print(future_dataList_1_0)
            fWriteCsvFile("dataset.csv", future_dataList_1_0)
            future_dataList_1_0.clear()
            print("##############################################")


# Comment : Bu fonksiyon content kismina gonderilen veriyi csv dosyasina yazar.
def fWriteCsvFile(filename, content):
    with open(filename, 'a+', newline='') as write_obj:
        csv_writer = csv.writer(write_obj)
        csv_writer.writerow(content)

#///////////////////////////////////////////////////////////////////////
#///////////////////////////////////////////////////////////////////////
#////////////////// CLASSIFICATION ALGORITHM ///////////////////////////
#///////////////////////////////////////////////////////////////////////
#//////////////////////// F_Measure ////////////////////////////////////
#////////////////////// KNN - NB - SVM//////////////////////////////////
#///////////////////////////////////////////////////////////////////////
#///////////////////////////////////////////////////////////////////////
def F_Measure(cm):
    TP = cm[0, 0]
    FP = cm[0, 1]
    FN = cm[1, 0]
    TN = cm[1, 1]
    recall = (TP/(TP+FN))
    precision = (TP/(TP+FP))
    return ((2*recall*precision)/(recall+precision))

# Comment : Bu fonksiyon KNN Algoritmasidir.
def KNN(data, mType):
    X_train, X_test, y_train, y_test = train_test_split(data.drop(["STATUS"], axis=1), data.STATUS, test_size=0.2)

    snf = KNeighborsClassifier(n_neighbors=5, metric='euclidean')
    snf.fit(X_train, y_train)

    print("########## ", mType, " ##########")
    # print("Egitim Orani : ",snf.score(X_train, y_egitim))
    # print("Test Orani : ",snf.score(X_test, y_test))

    y_pred = snf.predict(X_test)
    cm = confusion_matrix(y_test,y_pred)
    F_measure = F_Measure(cm)
    print("Tahmin Dogruluk Orani", accuracy_score(y_test, y_pred))
    print("F-Measure",F_measure)

def NaiveBayes(data, mType):
    X_train, X_test, y_train, y_test = train_test_split(data.drop(["STATUS"], axis=1), data.STATUS, test_size=0.2)

    snf = MultinomialNB().fit(X_train, y_train)
    print("########## ", mType, " ##########")
    # print("Egitim Orani : ", snf.score(X_train, y_train))
    # print("Test Orani : ", snf.score(X_test, y_test))
    y_pred = snf.predict(X_test)
    cm = confusion_matrix(y_test, y_pred)
    F_measure = F_Measure(cm)
    print("Tahmin Dogruluk Orani", accuracy_score(y_test, y_pred))
    print("F-Measure", F_measure)


def SVM(data, mType):
    
    X_train, X_test, y_train, y_test = train_test_split(data.drop(["STATUS"], axis=1), data.STATUS, test_size=0.2)
    snf = svm.SVC(kernel='linear', C=1).fit(X_train, y_train)
    print("########## ", mType, " ##########")
    # print("Egitim Orani : ", snf.score(X_train, y_train))
    # print("Test Orani : ", snf.score(X_test, y_test))
    y_pred = snf.predict(X_test)
    cm = confusion_matrix(y_test, y_pred)
    F_measure = F_Measure(cm)
    print("Tahmin Dogruluk Orani", accuracy_score(y_test, y_pred))
    print("F-Measure", F_measure)



#///////////////////////////////////////////////////////////////////////
#///////////////////////////////////////////////////////////////////////
#/////////////////////// TEXT CLASSIFICATION ///////////////////////////
#///////////////////////////////////////////////////////////////////////
#//////////////// PrepearDataForTextClassification /////////////////////
#//////////////// IDF - OR - MI - TGF - IDFEC //////////////////////////
#//////////////// RF - GSS - IG - GR - DESCR  //////////////////////////
#///////////////////... DISCR - FDD - CHI //////////////////////////////
#///////////////////////////////////////////////////////////////////////
#///////////////////////////////////////////////////////////////////////

def PrepearDataForTextClassification():
    global a_list, b_list, c_list, d_list
    malwareDataset = pd.read_csv("2000Malware.csv", delimiter=";")
    beignDataset = pd.read_csv("1000Beign.csv", delimiter=";")

    malwareDataset.drop("STATUS", axis=1)
    for item in malwareDataset.columns:
        seri = np.asarray(malwareDataset[item].value_counts())
        a = seri[0]
        a_list.append(a)
        if (a < 2000):
            b = seri[1]
            b_list.append(b)
        else:
            b = 0
            b_list.append(b)

    beignDataset.drop("STATUS", axis=1)
    for item in beignDataset.columns:
        seri = np.asarray(beignDataset[item].value_counts())
        c = seri[0]
        c_list.append(c)
        if (c < 1000):
            d = seri[1]
            d_list.append(d)
        else:
            d = 0
            d_list.append(d)


def IDF(data):
    global a_list, b_list, c_list, d_list
    IDF_Weight = []
    try:

        for i in range(0, len(a_list)):
            a = a_list[i]
            b = b_list[i]
            c = c_list[i]
            d = d_list[i]
            n = a + b + c + d
            IDF_Weight.append(math.log(n / (a + c)))

        toplam = 0.0
        idfColumn = []
        for dataIndex in data.values:
            for index in range(0, len(IDF_Weight)):
                toplam = toplam + (dataIndex[index] * IDF_Weight[index])

            idfColumn.append(toplam)
            toplam = 0.0

        idfColumn = pd.DataFrame(idfColumn)
        data2 = data.assign(IDF=idfColumn)
        return data2

    except ValueError:
        print("Upss! Unexpected Error.")

def CHI(data):
    global a_list, b_list, c_list, d_list
    CHI_Weight = []
    try:

        for i in range(0, len(a_list)):
            a = a_list[i]
            b = b_list[i]
            c = c_list[i]
            d = d_list[i]
            n = a + b + c + d
            e = (a+c)*(b+d)*(a+b)*(c+d)
            if (e == 0): e = 1
            CHI_Weight.append(n*(math.pow(((a*d)-(b*c)),2)/e))


        toplam = 0.0
        idfColumn = []
        for dataIndex in data.values:
            for index in range(0, len(CHI_Weight)):
                toplam = toplam + (dataIndex[index] * CHI_Weight[index])

            idfColumn.append(toplam)
            toplam = 0.0

        idfColumn = pd.DataFrame(idfColumn)
        data2 = data.assign(CHI=idfColumn)
        return data2

    except ValueError:
        print("Upss! Unexpected Error.")

def OR(data):
    global a_list, b_list, c_list, d_list
    Weight = []
    try:

        for i in range(0, len(a_list)):
            a = a_list[i]
            b = b_list[i]
            c = c_list[i]
            d = d_list[i]
            n = a + b + c + d
            e = b * c
            f = a * d
            if (e == 0):
                e = 1
            if (f == 0):
                f = 1
            result = math.log(f / e)
            #if (result < 0):
                #result = result * -1
            Weight.append(result)

        toplam = 0.0
        idfColumn = []
        for dataIndex in data.values:
            for index in range(0, len(Weight)):
                toplam = toplam + (dataIndex[index] * Weight[index])

            idfColumn.append(toplam)
            toplam = 0.0

        idfColumn = pd.DataFrame(idfColumn)
        data2 = data.assign(OR=idfColumn)
        return data2

    except ValueError:
        print("Upss! Unexpected Error.")


def MI(data):
    global a_list, b_list, c_list, d_list
    Weight = []
    try:

        for i in range(0, len(a_list)):
            a = a_list[i]
            b = b_list[i]
            c = c_list[i]
            d = d_list[i]
            n = a + b + c + d
            result = math.log(n*(a/((a+b)*(a+c))))
            Weight.append(result)

        toplam = 0.0
        miColumn = []
        for dataIndex in data.values:
            for index in range(0, len(Weight)):
                toplam = toplam + (dataIndex[index] * Weight[index])

            miColumn.append(toplam)
            toplam = 0.0

        miColumn = pd.DataFrame(miColumn)
        data2 = data.assign(MI=miColumn)
        return data2

    except ValueError:
        print("Upss! Unexpected Error.")


def TGF(data):
    global a_list, b_list, c_list, d_list
    Weight = []
    try:

        for i in range(0, len(a_list)):
            a = a_list[i]
            c = c_list[i]
            Weight.append(a+c)

        toplam = 0.0
        idfColumn = []
        for dataIndex in data.values:
            for index in range(0, len(Weight)):
                toplam = toplam + (dataIndex[index] * Weight[index])

            idfColumn.append(toplam)
            toplam = 0.0

        idfColumn = pd.DataFrame(idfColumn)
        data2 = data.assign(TGF=idfColumn)
        return data2

    except ValueError:
        print("Upss! Unexpected Error.")


def IDFEC(data):
    global a_list, b_list, c_list, d_list
    Weight = []
    try:

        for i in range(0, len(a_list)):
            d = d_list[i]
            c = c_list[i]
            if (c==0): c=1
            Weight.append(math.log((c+d)/c))

        toplam = 0.0
        idfColumn = []
        for dataIndex in data.values:
            for index in range(0, len(Weight)):
                toplam = toplam + (dataIndex[index] * Weight[index])

            idfColumn.append(toplam)
            toplam = 0.0

        idfColumn = pd.DataFrame(idfColumn)
        data2 = data.assign(IDFEC=idfColumn)
        return data2

    except ValueError:
        print("Upss! Unexpected Error.")


def RF(data):
    global a_list, b_list, c_list, d_list
    Weight = []
    try:

        for i in range(0, len(a_list)):
            a = a_list[i]
            c = c_list[i]
            if (c == 0): c = 1
            Weight.append(math.log(2 + a / c))

        toplam = 0.0
        idfColumn = []
        for dataIndex in data.values:
            for index in range(0, len(Weight)):
                toplam = toplam + (dataIndex[index] * Weight[index])

            idfColumn.append(toplam)
            toplam = 0.0

        idfColumn = pd.DataFrame(idfColumn)
        data2 = data.assign(RF=idfColumn)
        return data2

    except ValueError:
        print("Upss! Unexpected Error.")


def GSS(data):
    global a_list, b_list, c_list, d_list
    Weight = []
    try:

        for i in range(0, len(a_list)):
            a = a_list[i]
            c = c_list[i]
            d = d_list[i]
            if (c == 0): c = 1
            Weight.append(math.log(2 + ((a+c+d) / c)))

        toplam = 0.0
        idfColumn = []
        for dataIndex in data.values:
            for index in range(0, len(Weight)):
                toplam = toplam + (dataIndex[index] * Weight[index])

            idfColumn.append(toplam)
            toplam = 0.0

        idfColumn = pd.DataFrame(idfColumn)
        data2 = data.assign(GSS=idfColumn)
        return data2

    except ValueError:
        print("Upss! Unexpected Error.")


def IG(data):
    global a_list, b_list, c_list, d_list
    Weight = []
    try:

        for i in range(0, len(a_list)):
            a = a_list[i]
            b = b_list[i]
            c = c_list[i]
            d = d_list[i]
            n = a + b + c + d
            e = a+b
            f = a+c
            g = b+d
            if(g==0): g= 1
            Weight.append((a/n)*math.log(n/f) - (e/n)*math.log(e/n) + (b/n)*math.log(b/g))

        toplam = 0.0
        idfColumn = []
        for dataIndex in data.values:
            for index in range(0, len(Weight)):
                toplam = toplam + (dataIndex[index] * Weight[index])

            idfColumn.append(toplam)
            toplam = 0.0

        idfColumn = pd.DataFrame(idfColumn)
        data2 = data.assign(IG=idfColumn)
        return data2

    except ValueError:
        print("Upss! Unexpected Error.")


def GR(data):
    global a_list, b_list, c_list, d_list
    Weight = []
    try:

        for i in range(0, len(a_list)):
            a = a_list[i]
            b = b_list[i]
            c = c_list[i]
            d = d_list[i]
            n = a + b + c + d
            e = a+b
            f = a+c
            g = b+d
            h = c+d
            Weight.append(((a/n)*math.log(n/f) - (e/n)*math.log(e/n) + (b/n)*math.log(b/g)) / (-1)*(e/n)*math.log(e/n) - (h/n)*math.log(h/n))

        toplam = 0.0
        idfColumn = []
        for dataIndex in data.values:
            for index in range(0, len(Weight)):
                toplam = toplam + (dataIndex[index] * Weight[index])

            idfColumn.append(toplam)
            toplam = 0.0

        idfColumn = pd.DataFrame(idfColumn)
        data2 = data.assign(GR=idfColumn)
        return data2

    except ValueError:
        print("Upss! Unexpected Error.")


def DESCR(data):
    global a_list, b_list, c_list, d_list
    Weight = []
    try:

        for i in range(0, len(a_list)):
            a = a_list[i]
            b = b_list[i]

            Weight.append(a/(a+b))

        toplam = 0.0
        idfColumn = []
        for dataIndex in data.values:
            for index in range(0, len(Weight)):
                toplam = toplam + (dataIndex[index] * Weight[index])

            idfColumn.append(toplam)
            toplam = 0.0

        idfColumn = pd.DataFrame(idfColumn)
        data2 = data.assign(DESCR=idfColumn)
        return data2

    except ValueError:
        print("Upss! Unexpected Error.")


def DISCR(data):
    global a_list, b_list, c_list, d_list
    Weight = []
    try:

        for i in range(0, len(a_list)):
            a = a_list[i]
            c = c_list[i]

            Weight.append(a/(a+c))

        toplam = 0.0
        idfColumn = []
        for dataIndex in data.values:
            for index in range(0, len(Weight)):
                toplam = toplam + (dataIndex[index] * Weight[index])

            idfColumn.append(toplam)
            toplam = 0.0

        idfColumn = pd.DataFrame(idfColumn)
        data2 = data.assign(DISCR=idfColumn)
        return data2

    except ValueError:
        print("Upss! Unexpected Error.")


def FDD(data):
    global a_list, b_list, c_list, d_list
    Weight = []
    try:
        beta = 0.477
        for i in range(0, len(a_list)):
            a = a_list[i]
            b = b_list[i]
            c = c_list[i]
            descr = (a/(a+b))
            discr = (a/(a+c))
            Weight.append(((1+beta*beta)*discr* descr) / (beta*beta*(discr+descr)))

        toplam = 0.0
        idfColumn = []
        for dataIndex in data.values:
            for index in range(0, len(Weight)):
                toplam = toplam + (dataIndex[index] * Weight[index])

            idfColumn.append(toplam)
            toplam = 0.0

        idfColumn = pd.DataFrame(idfColumn)
        data2 = data.assign(FDD=idfColumn)
        return data2

    except ValueError:
        print("Upss! Unexpected Error.")

def convertToPositive(data):
    tempData=data
    for item in tempData.columns:
        seri = np.asarray(tempData[item])
        for i in range(0,len(seri)):
            if (seri[i] < 0 ):
                seri[i] = 0 # seri[i]* -1
    return tempData


#///////////////////////////////////////////////////////////////////////
#///////////////////////////////////////////////////////////////////////
#/////////////////////////////// MAIN //////////////////////////////////
#///////////////////////////////////////////////////////////////////////
#///////////////////////////////////////////////////////////////////////

# Yaklasik 6 saat surdu
# Comment : Apk dosyalarindan AndroidManifest.xml dosyasinin cikartilmasi
# fDecompileApk_and_ExtraxtAndroidManifestFile("C:/Users/OsmanDeniz/Development/Bitirme/MalwareDetection/PlayStoreApk","Playstore")
# Comment : Izinler Okunuyor
# fReadManifestFiles("C:/Users/OsmanDeniz/Development/Bitirme/MalwareDetection/PermissionPlayStoreApp/","being")


data = pd.read_csv("3000Dataset.csv", delimiter=";")
PrepearDataForTextClassification()
IDF_Data = IDF(data)
# CHI_Data = CHI(data)
# OR_Data = OR(data)
# RF_Data = RF(data)
# MI_Data = MI(data)
# TGF_Data = TGF(data)
# IDFEC_Data = TGF(data)
# GSS_Data = GSS(data)
# IG_Data = GSS(data)
# GR_Data = GSS(data)
# DESCR_Data = GSS(data)
# DISCR_Data = GSS(data)
# FDD_Data = GSS(data)


# Comment : KNN Binary

#KNN(data, "KNN Binary")
KNN(IDF_Data, "KNN IDF")
# KNN(CHI_Data, "KNN CHI_Data")
# KNN(OR_Data, "KNN OR")
# KNN(RF_Data, "KNN RF")
# KNN(MI_Data, "KNN MI")
# KNN(TGF_Data, "KNN TGF")
# KNN(IDFEC_Data, "KNN IDFEC")
# KNN(GSS_Data, "KNN GSS_Data")
# KNN(IG_Data, "KNN IG_Data")
# KNN(GR_Data, "KNN GR_Data")
# KNN(DESCR_Data, "KNN DESCR_Data")
# KNN(DISCR_Data, "KNN DISCR_Data")
# KNN(FDD_Data, "KNN FDD_Data")





# Comment : NaiveBayes
#NaiveBayes(data, "NaiveBayes - Binary")
NaiveBayes(IDF_Data, "NaiveBayes - IDF")
# NaiveBayes(CHI_Data, "NaiveBayes - CHI_Data")
# NaiveBayes(convertToPositive(MI_Data)," NaiveBayes OR ") # Negatif Deger Kabul etmiyor
# NaiveBayes(RF_Data," NaiveBayes RF ")
# NaiveBayes(convertToPositive(MI_Data)," NaiveBayes MI_Data ") # Negatif Deger Hatasi
# NaiveBayes(TGF_Data," NaiveBayes TGF ")
# NaiveBayes(IDFEC_Data," NaiveBayes IDFEC_Data ")
# NaiveBayes(GSS_Data," NaiveBayes GSS_Data ")
# NaiveBayes(IG_Data," NaiveBayes IG_Data ")
# NaiveBayes(GR_Data," NaiveBayes GR_Data ")
# NaiveBayes(DESCR_Data," NaiveBayes DESCR_Data ")
# NaiveBayes(DISCR_Data," NaiveBayes DISCR_Data ")
# NaiveBayes(FDD_Data," NaiveBayes FDD_Data ")

# Comment : SVM
#SVM(data, "SVM - Binary")
SVM(IDF_Data, "SVM - IDF")
# !! SVM(CHI_Data, "SVM - CHI_Data") #!
# SVM(OR_Data, "SVM - OR")
# SVM(RF_Data, "SVM - RF")
# SVM(MI_Data, "SVM - MI")
# !!SVM(TGF_Data, "SVM - TGF") #! islem cok uzun suruyor
# !!SVM(IDFEC_Data, "SVM - IDFEC_Data")#! islem cok uzun suruyor
# SVM(GSS_Data, "SVM - GSS_Data")
# SVM(IG_Data, "SVM - IG_Data")
# SVM(GR_Data, "SVM - GR_Data")
# SVM(DESCR_Data, "SVM - DESCR_Data")
# SVM(DISCR_Data, "SVM - DISCR_Data")
# SVM(FDD_Data, "SVM - FDD_Data")